<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Global Chat | Penguin Labs</title>
    <link rel="icon" type="image/x-icon" href="/logo.ico" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; margin: 0; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .msg { padding: 4px; border-radius: 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
        .name { font-weight: 700; font-size: 9px; }
        .text { font-size: 11px; color: #d1d5db; }
        .error { color: #ef4444; font-weight: 700; font-size: 11px; }
    </style>
</head>
<body class="selection:bg-blue-500/30">
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-900/10 blur-[120px] rounded-full -z-10"></div>
    <main class="min-h-screen pt-24 pb-16 px-6">
        <div class="max-w-4xl mx-auto">
            <div class="text-center space-y-3 mb-8">
                <h1 class="text-4xl md:text-5xl font-black tracking-tight">Global <span class="text-blue-400">Chat</span></h1>
                <p class="text-gray-400 text-sm">Anonymous, global chat with strong filtering</p>
            </div>
            <div class="glass rounded-[2rem] p-4 h-[72vh] overflow-y-auto" id="chat-list">
                <p class="text-center text-gray-500 py-10">Connecting…</p>
            </div>
            <div id="admin-tools" class="hidden mt-3 glass rounded-xl p-3">
                <div class="flex items-center gap-3 mb-3">
                    <input id="mute-input" type="text" placeholder="Mute name (e.g., anonymous1234)" class="flex-1 glass px-2.5 py-1.5 rounded-xl outline-none border border-white/10 focus:border-blue-500/50 text-xs">
                    <button id="mute-btn" class="bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-xl text-xs font-bold">Mute</button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="shutdown-btn" class="w-full bg-orange-600 hover:bg-orange-500 px-3 py-1.5 rounded-xl text-xs font-bold">Shutdown Chat</button>
                </div>
                <div class="flex items-center gap-3 mt-2">
                    <button id="clearall-btn" class="w-full bg-red-700 hover:bg-red-600 px-3 py-1.5 rounded-xl text-xs font-bold">Clear All Messages</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Admin tools available only after sending Dev Chat via Feedback.</p>
            </div>
            <div id="mute-panel" class="hidden fixed top-28 right-4 glass rounded-2xl p-3 w-56">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold text-gray-300">Muted Users</h2>
                    <span class="text-xs text-gray-500">Global</span>
                </div>
                <div id="mute-list" class="mt-3 space-y-2"></div>
            </div>
            <div id="rules-panel" class="hidden md:block fixed top-28 left-4 glass rounded-2xl p-3 w-56">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold text-gray-300">Chat Rules</h2>
                    <span class="text-xs text-gray-500">All Users</span>
                </div>
                <div class="mt-3 space-y-2 text-xs text-gray-400">
                    <p>No links, emails, or handles.</p>
                    <p>No hate speech or profanity.</p>
                    <p>Keep messages under 240 characters.</p>
                    <p>Be respectful and helpful.</p>
                </div>
                <div class="mt-3">
                    <h3 class="text-xs font-bold text-gray-300">Admin Actions</h3>
                    <ul class="mt-2 space-y-1 text-xs text-gray-400">
                        <li>Mute users (blocks sending only).</li>
                        <li>Delete rule-breaking messages.</li>
                        <li>Shutdown or reopen chat.</li>
                        <li>Clear all messages.</li>
                    </ul>
                </div>
                <div id="auto-clear-clock" class="mt-3 text-xs text-gray-400">Auto clear in: calculating…</div>
            </div>
            <div class="flex items-center gap-2 mt-3">
                <div id="anon-name" class="glass px-2 py-1.5 rounded-xl text-[10px] font-bold text-gray-300"></div>
                <input id="chat-input" type="text" placeholder="Type a message" class="flex-1 glass px-3 py-2 rounded-xl outline-none border border-white/10 focus:border-blue-500/50 text-sm">
                <button id="chat-send" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-xs font-bold">Send</button>
            </div>
            <div id="chat-error" class="error mt-2 hidden"></div>
        </div>
    </main>
    <script src="/js/nav.js"></script>
    <script>
        function getAnon() {
            try {
                var v = localStorage.getItem('anon_name');
                if (v) return v;
                var n = 'anonymous' + String(Math.floor(1000 + Math.random()*9000));
                localStorage.setItem('anon_name', n);
                return n;
            } catch(e) { return 'anonymous' + String(Math.floor(1000 + Math.random()*9000)); }
        }
        function normalize(s){ return (s||'').replace(/\s+/g,' ').trim(); }
        function collapseRepeats(s){ return String(s||'').replace(/(.)\1+/g,'$1'); }
        function leet(s){
            return String(s||'').replace(/\$/g,'s').replace(/@/g,'a').replace(/0/g,'o').replace(/[1!]/g,'i').replace(/3/g,'e').replace(/4/g,'a').replace(/5/g,'s').replace(/7/g,'t').replace(/\+/g,'t');
        }
        function alphaNum(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
        function compact(s){ return String(s||'').toLowerCase().replace(/[\s\.\-\_\(\)\[\]\{\},;:'"`~\\\/]+/g,''); }
        function dist1(a,b){
            var m=a.length,n=b.length;
            if (Math.abs(m-n)>1) return 2;
            var i=0,j=0,d=0;
            while(i<m && j<n){
                if(a.charCodeAt(i)===b.charCodeAt(j)){ i++; j++; }
                else {
                    d++;
                    if(d>1) return d;
                    if(m>n){ i++; }
                    else if(n>m){ j++; }
                    else {
                        if(i+1<m && j+1<n && a.charCodeAt(i+1)===b.charCodeAt(j) && a.charCodeAt(i)===b.charCodeAt(j+1)){ i+=2; j+=2; }
                        else { i++; j++; }
                    }
                }
            }
            if(i<m || j<n) d++;
            return d;
        }
        function nearContains(h, term){
            var L = term.length;
            for (var len=Math.max(1,L-1); len<=L+1; len++){
                if (len>h.length) break;
                for (var k=0; k<=h.length-len; k++){
                    var sub = h.slice(k, k+len);
                    if (sub === term) return true;
                    if (dist1(sub, term) <= 1) return true;
                }
            }
            return false;
        }
        function hasUrl(s){
            var l = String(s||'').toLowerCase();
            var c = compact(l);
            var a = alphaNum(leet(l));
            if (/(http|https|www|discord|mailto)/i.test(c)) return true;
            if (/@/.test(l)) return true;
            if (/\b(at|dot)\b/.test(l)) return true;
            var tlds = ['com','net','org','io','gg','xyz','ru','cn','de','uk','us','co','edu','gov','me','app','dev','shop','info','tv','ly','tk'];
            for (var i=0;i<tlds.length;i++){
                var t = tlds[i];
                if (c.indexOf(t) !== -1) return true;
            }
            if (/[a-z0-9]+@[a-z0-9]+\.[a-z0-9]+/.test(a)) return true;
            return false;
        }
        function tooShort(s){ return s.length < 2; }
        function tooLong(s){ return s.length > 240; }
        function banned(s){
            var base = String(s||'').toLowerCase();
            var t = collapseRepeats(base);
            var a = alphaNum(t);
            var l = alphaNum(leet(t));
            var w = [
                'idiot','stupid','dumb','hate','kill','murder','rape','trash','noob','loser','racist','sex','porn','nsfw','slur','kys','suicide','die','ugly','fat',
                'retard','retarded','bitch','btch','biatch','fuck','shit','asshole','damn','nigger','fag','faggot','cunt','whore','dick','cock','pussy','boobs','tits','cum','sext',
                'bloody','gore','knife','gun','shoot','bomb','terror','drugs','weed','vape','meth','cocaine','heroin','lsd',
                'discord','invite','server','dm','link','http','https','www','email','gmail','yahoo','outlook','snap','instagram','tiktok','kik','whatsapp','telegram'
            ];
            for (var i=0;i<w.length;i++){
                var k = w[i];
                if (base.indexOf(k) !== -1) return true;
                if (a.indexOf(k) !== -1) return true;
                if (l.indexOf(k) !== -1) return true;
                if (nearContains(a, k)) return true;
                if (nearContains(l, k)) return true;
            }
            return false;
        }
        function sanitize(s){
            var x = normalize(s);
            if (tooShort(x)) return { ok:false, reason:'Message too short' };
            if (tooLong(x)) return { ok:false, reason:'Message too long' };
            if (hasUrl(x)) return { ok:false, reason:'Blocked by strict filter' };
            if (banned(x)) return { ok:false, reason:'Blocked by strict filter' };
            return { ok:true, text:x };
        }
        function checkHistoryViolation(anon, text){
            return new Promise(function(resolve){
                try {
                    var fallback = function(){
                        var combined = String(text||'');
                        if (hasUrl(combined) || banned(combined)) return resolve({ ok:false, reason:'Blocked by strict multi-message filter' });
                        resolve({ ok:true });
                    };
                    if (typeof firebase === 'undefined' || typeof firebase.database !== 'function') return fallback();
                    firebase.database().ref('global_chat').limitToLast(50).once('value', function(snap){
                        var arr = [];
                        snap.forEach(function(child){
                            var v = child.val()||{};
                            if (String(v.name||'') === String(anon)) arr.push(String(v.message||''));
                        });
                        var combined = (arr.join(' ') + ' ' + String(text||'')).slice(0, 2000);
                        if (hasUrl(combined) || banned(combined)) return resolve({ ok:false, reason:'Blocked by strict multi-message filter' });
                        resolve({ ok:true });
                    }, function(){ fallback(); });
                } catch(e){ resolve({ ok:true }); }
            });
        }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);}); }
        function renderChat(items){
            var list = document.getElementById('chat-list');
            if (!list) return;
            if (!items.length){ list.innerHTML = '<p class="text-center text-gray-500 py-10">No messages yet.</p>'; return; }
            var isDev = localStorage.getItem('dev_access') === 'true';
            var html = items.map(function(m){
                var rawName = m.displayName || m.name || 'anonymous';
                var name = escapeHtml(rawName);
                var anonName = escapeHtml(m.name||'anonymous');
                var text = escapeHtml(m.message||'');
                var nlow = String(rawName).toLowerCase();
                var nameClass = (nlow === 'chief penguin' || nlow === 'lead penguin') ? 'text-red-500' : 'text-blue-400';
                var isAdminMsg = (nlow === 'chief penguin' || nlow === 'lead penguin');
                var myAnon = getAnon();
                var isOwner = String(m.name||'') === String(myAnon);
                var admin = '';
                if (isDev) {
                    if (isAdminMsg) {
                        if (isOwner) {
                            admin = '<div class="mt-2 flex gap-3"><button class="text-xs text-red-400 hover:text-red-300 font-bold" onclick="deleteGlobalChatMessage(\''+(m.key||'')+'\')">Delete</button></div>';
                        }
                    } else {
                        admin = '<div class="mt-2 flex gap-3"><button class="text-xs text-red-400 hover:text-red-300 font-bold" onclick="deleteGlobalChatMessage(\''+(m.key||'')+'\')">Delete</button><button class="text-xs text-yellow-400 hover:text-yellow-300 font-bold" onclick="muteGlobalName(\''+anonName+'\')">Mute '+anonName+'</button></div>';
                    }
                }
                return '<div class="msg mb-1"><div class="name '+nameClass+'">'+name+'</div><div class="text">'+text+'</div>'+admin+'</div>';
            }).join('');
            list.innerHTML = html;
            list.scrollTop = list.scrollHeight;
        }
        function renderMutes(mutesObj){
            var panel = document.getElementById('mute-panel');
            var list = document.getElementById('mute-list');
            var isDev = localStorage.getItem('dev_access') === 'true';
            if (!panel || !list) return;
            if (!isDev) { panel.classList.add('hidden'); list.innerHTML=''; return; }
            panel.classList.remove('hidden');
            var keys = Object.keys(mutesObj||{});
            if (!keys.length){
                list.innerHTML = '<div class="text-xs text-gray-500">No muted users</div>';
                return;
            }
            var html = keys.map(function(k){
                var n = escapeHtml(k);
                return '<div class="flex items-center justify-between glass rounded-xl px-3 py-2"><span class="text-xs font-bold text-gray-300">'+n+'</span><button class="text-xs bg-green-600 hover:bg-green-500 px-3 py-1 rounded-lg font-bold" onclick="deleteGlobalMute(\''+n+'\')">Unmute</button></div>';
            }).join('');
            list.innerHTML = html;
        }
        function setError(msg){
            var el = document.getElementById('chat-error');
            if (!el) return;
            if (!msg){ el.classList.add('hidden'); el.textContent=''; return; }
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function rateOk(){
            var k = 'global_chat_last';
            var now = Date.now();
            try {
                var prev = parseInt(localStorage.getItem(k)||'0',10);
                if (now - prev < 3000) return false;
                localStorage.setItem(k, String(now));
                return true;
            } catch(e){ return true; }
        }
        (function init(){
            var anon = getAnon();
            var isDev = localStorage.getItem('dev_access') === 'true';
            var role = isDev ? (localStorage.getItem('dev_role') || '') : '';
            var nameEl = document.getElementById('anon-name');
            if (nameEl) {
                nameEl.textContent = (role || anon);
                var rl = String(role||'').toLowerCase();
                if (rl === 'chief penguin' || rl === 'lead penguin') {
                    nameEl.classList.remove('text-gray-300');
                    nameEl.classList.add('text-red-500');
                }
            }
            var adminTools = document.getElementById('admin-tools');
            if (isDev && adminTools) adminTools.classList.remove('hidden');
            var muteBtn = document.getElementById('mute-btn');
            var muteInput = document.getElementById('mute-input');
            if (isDev && muteBtn && muteInput) {
                muteBtn.addEventListener('click', function(){
                    var n = normalize(muteInput.value||'');
                    if (!n) return;
                    muteGlobalName(n);
                    muteInput.value = '';
                });
            }
            var isShutdown = false;
            var isMuted = false;
            
            function updateShutdownUI(){
                var input = document.getElementById('chat-input');
                var btn = document.getElementById('chat-send');
                var shutdownBtn = document.getElementById('shutdown-btn');
                var isDev = localStorage.getItem('dev_access') === 'true';
                
                if (isMuted) {
                    if (input) { input.disabled = true; input.placeholder = "You are muted by admin."; }
                    if (btn) { btn.disabled = true; btn.classList.add('opacity-50'); }
                    setError('You are muted by admin');
                    return;
                } else {
                    setError('');
                }
                
                if (isShutdown) {
                    if (shutdownBtn) shutdownBtn.textContent = "Open Chat";
                    if (!isDev) {
                        if (input) { input.disabled = true; input.placeholder = "Chat is currently disabled by admin."; }
                        if (btn) { btn.disabled = true; btn.classList.add('opacity-50'); }
                    } else {
                        // Admins can still type
                        if (input) { input.disabled = false; input.placeholder = "Chat disabled for others (You can type)"; }
                        if (btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }
                    }
                } else {
                    if (shutdownBtn) shutdownBtn.textContent = "Shutdown Chat";
                    if (input) { input.disabled = false; input.placeholder = "Type a message"; }
                    if (btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }
                }
            }

            function send(){
                if (isShutdown && localStorage.getItem('dev_access') !== 'true') return;
                var input = document.getElementById('chat-input');
                var btn = document.getElementById('chat-send');
                if (!input || !btn) return;
                if (isMuted) { setError('You are muted by admin'); return; }
                var s = sanitize(input.value||'');
                if (!s.ok){ setError(s.reason); return; }
                checkHistoryViolation(anon, s.text).then(function(h){
                    if (!h.ok){ setError(h.reason); return; }
                    setError('');
                    if (!rateOk()){ setError('Slow down'); return; }
                    btn.disabled = true;
                    var nameToUse = role || anon;
                    var payload = { name: anon, displayName: nameToUse, message: s.text, type: 'Global Chat' };
                    function handleSuccess(){ input.value=''; btn.disabled = false; }
                    if (typeof submitGlobalChat === 'function') {
                        var p = submitGlobalChat(payload);
                        if (p && typeof p.then === 'function') {
                            p.then(handleSuccess).catch(function(e){ setError('Error: ' + (e && e.message ? e.message : e)); btn.disabled = false; });
                        } else {
                            handleSuccess();
                        }
                    } else {
                        btn.disabled = false;
                        setError('Connection unavailable');
                    }
                });
            }
            document.getElementById('chat-send').addEventListener('click', send);
            document.getElementById('chat-input').addEventListener('keypress', function(e){ if (e.key === 'Enter'){ e.preventDefault(); send(); } });
            
            var shutBtn = document.getElementById('shutdown-btn');
            if (shutBtn) {
                shutBtn.addEventListener('click', function(){
                    if (localStorage.getItem('dev_access') !== 'true') return;
                    firebase.database().ref('chat_shutdown').set(!isShutdown);
                });
            }
            var clearBtn = document.getElementById('clearall-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function(){
                    if (localStorage.getItem('dev_access') !== 'true') return;
                    var ok = confirm('Clear all global messages? This cannot be undone.');
                    if (!ok) return;
                    if (typeof clearGlobalChat === 'function') {
                        clearGlobalChat();
                    } else {
                        firebase.database().ref('global_chat').remove();
                    }
                });
            }

            function startListen(){
                var log = document.getElementById('chat-list');
                if (typeof firebase === 'undefined') {
                    if(log) log.innerHTML = '<p class="text-center text-red-500 py-10">Error: Firebase SDK not loaded.</p>';
                    return;
                }
                if (typeof firebase.database !== 'function') {
                     // Database SDK might not be loaded yet even if App SDK is. Wait for it.
                     console.log("firebase.database not found, waiting...");
                     setTimeout(startListen, 500);
                     return;
                }

                try {
                    var db = firebase.database();
                    var connectedRef = db.ref('.info/connected');
                    var offsetRef = db.ref('.info/serverTimeOffset');
                    var serverOffset = 0;
                    offsetRef.on('value', function(snap){ 
                        var off = snap.val();
                        if (typeof off === 'number') serverOffset = off; 
                    });
                    var earliestStart = 0;
                    var clockEl = document.getElementById('auto-clear-clock');
                    var clockTimer = null;
                    function updateClock(){
                        if (!clockEl) return;
                        if (!earliestStart) { clockEl.textContent = 'Auto clear in: —'; return; }
                        var nowServer = Date.now() + (serverOffset||0);
                        var target = earliestStart + (60*60*1000);
                        var remain = Math.max(0, target - nowServer);
                        var hrs = Math.floor(remain / 3600000);
                        var mins = Math.floor((remain % 3600000) / 60000);
                        var secs = Math.floor((remain % 60000) / 1000);
                        function pad(n){ return n<10 ? ('0'+n) : String(n); }
                        var s = (hrs>0 ? (hrs + ':' + pad(mins) + ':' + pad(secs)) : (mins + ':' + pad(secs)));
                        clockEl.textContent = 'Auto clear in: ' + s;
                    }
                    connectedRef.on('value', function(snap){
                        if (snap.val() === true) {
                            // Connected
                        } else {
                            // Disconnected or connecting
                        }
                    });

                    db.ref('chat_shutdown').on('value', function(s){
                        isShutdown = s.val() === true;
                        updateShutdownUI();
                    });
    
                    var mutes = {};
                    db.ref('global_chat_mutes').on('value', function(s){ 
                        mutes = (s.val()||{}); 
                        renderMutes(mutes); 
                        var mySafe = String(anon||'').toLowerCase().replace(/[^a-z0-9_-]/g,'');
                        isMuted = !!(mySafe && mutes[mySafe]);
                        updateShutdownUI();
                    });
                    
                    var chatRef = db.ref('global_chat').limitToLast(100);
                    
                    // Set a timeout to warn if data doesn't load
                    var loadTimeout = setTimeout(function(){
                        if(log && log.textContent.includes('Connecting')) {
                            log.innerHTML = '<p class="text-center text-yellow-500 py-10">Connection slow... check your internet or firewall.</p>';
                        }
                    }, 5000);

                    chatRef.on('value', function(snap){
                        clearTimeout(loadTimeout);
                        var arr = [];
                        var earliest = 0;
                        snap.forEach(function(child){
                            var v = child.val()||{};
                            var realName = String(v.displayName || v.name || '').toLowerCase();
                            var realSafe = realName.replace(/[^a-z0-9_-]/g,'');
                            
                            var nm = String(v.name||'').toLowerCase();
                            var nmSafe = nm.replace(/[^a-z0-9_-]/g,'');
                            
                            // Do not hide muted users' past messages
                            // Admin role messages are always shown
                            arr.push({ key: child.key, name: v.name, displayName: v.displayName, message: v.message, timestamp: v.timestamp||0 });
                            if (v.timestamp && (earliest === 0 || v.timestamp < earliest)) earliest = v.timestamp;
                        });
                        arr.sort(function(a,b){ return (a.timestamp||0) - (b.timestamp||0); });
                        renderChat(arr);
                        earliestStart = earliest || 0;
                        updateClock();
                        if (!clockTimer) clockTimer = setInterval(updateClock, 1000);
                    }, function(error){
                         clearTimeout(loadTimeout);
                         if(log) log.innerHTML = '<p class="text-center text-red-500 py-10">Error loading chat: '+escapeHtml(error.message)+'</p>';
                    });
                    
                    function cleanupOldMessages(){
                        try {
                            var nowServer = Date.now() + (serverOffset||0);
                            if (earliestStart && (nowServer - earliestStart >= (60 * 60 * 1000))) {
                                db.ref('global_chat').remove().then(function(){
                                    // cleared
                                });
                            }
                        } catch(e){}
                    }
                    setInterval(cleanupOldMessages, 60000);
                } catch(e) {
                    if(log) log.innerHTML = '<p class="text-center text-red-500 py-10">Init Error: '+escapeHtml(e.message)+'</p>';
                }
            }
            if (typeof firebase === 'undefined') {
                document.addEventListener('firebase-ready', startListen, { once: true });
            } else {
                startListen();
            }
        })();
    </script>
</body>
</html>
