<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Global Chat | Penguin Labs</title>
    <link rel="icon" type="image/x-icon" href="/logo.ico" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; margin: 0; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .msg { padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
        .name { font-weight: 700; font-size: 12px; }
        .text { font-size: 14px; color: #d1d5db; }
        .error { color: #ef4444; font-weight: 700; font-size: 12px; }
    </style>
</head>
<body class="selection:bg-blue-500/30">
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-900/10 blur-[120px] rounded-full -z-10"></div>
    <main class="min-h-screen pt-32 pb-20 px-6">
        <div class="max-w-3xl mx-auto">
            <div class="text-center space-y-3 mb-8">
                <h1 class="text-4xl md:text-5xl font-black tracking-tight">Global <span class="text-blue-400">Chat</span></h1>
                <p class="text-gray-400 text-sm">Anonymous, global chat with strong filtering</p>
            </div>
            <div class="glass rounded-[2rem] p-6 h-[60vh] overflow-y-auto" id="chat-list">
                <p class="text-center text-gray-500 py-10">Connectingâ€¦</p>
            </div>
            <div id="admin-tools" class="hidden mt-4 glass rounded-xl p-4">
                <div class="flex items-center gap-3 mb-3">
                    <input id="mute-input" type="text" placeholder="Mute name (e.g., anonymous1234)" class="flex-1 glass px-3 py-2 rounded-xl outline-none border border-white/10 focus:border-blue-500/50 text-sm">
                    <button id="mute-btn" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-xl text-sm font-bold">Mute</button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="shutdown-btn" class="w-full bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded-xl text-sm font-bold">Shutdown Chat</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Admin tools available only after sending Dev Chat via Feedback.</p>
            </div>
            <div id="mute-panel" class="hidden fixed top-32 right-6 glass rounded-2xl p-4 w-64">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold text-gray-300">Muted Users</h2>
                    <span class="text-xs text-gray-500">Global</span>
                </div>
                <div id="mute-list" class="mt-3 space-y-2"></div>
            </div>
            <div class="flex items-center gap-3 mt-4">
                <div id="anon-name" class="glass px-3 py-2 rounded-xl text-xs font-bold text-gray-300"></div>
                <input id="chat-input" type="text" placeholder="Type a message" class="flex-1 glass px-4 py-3 rounded-xl outline-none border border-white/10 focus:border-blue-500/50">
                <button id="chat-send" class="bg-blue-600 hover:bg-blue-500 px-5 py-3 rounded-xl text-sm font-bold">Send</button>
            </div>
            <div id="chat-error" class="error mt-2 hidden"></div>
        </div>
    </main>
    <script src="/js/nav.js"></script>
    <script>
        function getAnon() {
            try {
                var v = localStorage.getItem('anon_name');
                if (v) return v;
                var n = 'anonymous' + String(Math.floor(1000 + Math.random()*9000));
                localStorage.setItem('anon_name', n);
                return n;
            } catch(e) { return 'anonymous' + String(Math.floor(1000 + Math.random()*9000)); }
        }
        function normalize(s){ return (s||'').replace(/\s+/g,' ').trim(); }
        function hasUrl(s){ return /(https?:\/\/|www\.|\.com|\.net|\.org|\.io|discord\.|@)/i.test(s); }
        function tooShort(s){ return s.length < 2; }
        function tooLong(s){ return s.length > 240; }
        function banned(s){
            var w = ['idiot','stupid','dumb','hate','kill','trash','noob','loser','racist','sex','porn','nsfw','slur','kys','suicide','die','ugly','fat','retard','retarded','bitch','fuck','shit','asshole','damn','nigger','fag','faggot','cunt','whore'];
            var t = s.toLowerCase();
            for (var i=0;i<w.length;i++){ if (t.indexOf(w[i]) !== -1) return true; }
            return false;
        }
        function sanitize(s){
            var x = normalize(s);
            if (tooShort(x)) return { ok:false, reason:'Message too short' };
            if (tooLong(x)) return { ok:false, reason:'Message too long' };
            if (hasUrl(x)) return { ok:false, reason:'Links, emails, or handles blocked' };
            if (banned(x)) return { ok:false, reason:'Message blocked by filter' };
            return { ok:true, text:x };
        }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);}); }
        function renderChat(items){
            var list = document.getElementById('chat-list');
            if (!list) return;
            if (!items.length){ list.innerHTML = '<p class="text-center text-gray-500 py-10">No messages yet.</p>'; return; }
            var isDev = localStorage.getItem('dev_access') === 'true';
            var html = items.map(function(m){
                var name = escapeHtml(m.name||'anonymous');
                var text = escapeHtml(m.message||'');
                var nlow = String(rawName).toLowerCase();
                var nameClass = (nlow === 'chief penguin' || nlow === 'lead penguin') ? 'text-red-500' : 'text-blue-400';
                var isAdminMsg = (nlow === 'chief penguin' || nlow === 'lead penguin');
                var admin = '';
                if (isDev && !isAdminMsg) {
                    admin = '<div class="mt-2 flex gap-3"><button class="text-xs text-red-400 hover:text-red-300 font-bold" onclick="deleteGlobalChatMessage(\''+(m.key||'')+'\')">Delete</button><button class="text-xs text-yellow-400 hover:text-yellow-300 font-bold" onclick="muteGlobalName(\''+name+'\')">Mute '+name+'</button></div>';
                }
                return '<div class="msg mb-3"><div class="name '+nameClass+'">'+name+'</div><div class="text">'+text+'</div>'+admin+'</div>';
            }).join('');
            list.innerHTML = html;
            list.scrollTop = list.scrollHeight;
        }
        function renderMutes(mutesObj){
            var panel = document.getElementById('mute-panel');
            var list = document.getElementById('mute-list');
            var isDev = localStorage.getItem('dev_access') === 'true';
            if (!panel || !list) return;
            if (!isDev) { panel.classList.add('hidden'); list.innerHTML=''; return; }
            panel.classList.remove('hidden');
            var keys = Object.keys(mutesObj||{});
            if (!keys.length){
                list.innerHTML = '<div class="text-xs text-gray-500">No muted users</div>';
                return;
            }
            var html = keys.map(function(k){
                var n = escapeHtml(k);
                return '<div class="flex items-center justify-between glass rounded-xl px-3 py-2"><span class="text-xs font-bold text-gray-300">'+n+'</span><button class="text-xs bg-green-600 hover:bg-green-500 px-3 py-1 rounded-lg font-bold" onclick="deleteGlobalMute(\''+n+'\')">Unmute</button></div>';
            }).join('');
            list.innerHTML = html;
        }
        function setError(msg){
            var el = document.getElementById('chat-error');
            if (!el) return;
            if (!msg){ el.classList.add('hidden'); el.textContent=''; return; }
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function rateOk(){
            var k = 'global_chat_last';
            var now = Date.now();
            try {
                var prev = parseInt(localStorage.getItem(k)||'0',10);
                if (now - prev < 3000) return false;
                localStorage.setItem(k, String(now));
                return true;
            } catch(e){ return true; }
        }
        (function init(){
            var anon = getAnon();
            var isDev = localStorage.getItem('dev_access') === 'true';
            var role = isDev ? (localStorage.getItem('dev_role') || '') : '';
            var nameEl = document.getElementById('anon-name');
            if (nameEl) {
                nameEl.textContent = (role || anon);
                var rl = String(role||'').toLowerCase();
                if (rl === 'chief penguin' || rl === 'lead penguin') {
                    nameEl.classList.remove('text-gray-300');
                    nameEl.classList.add('text-red-500');
                }
            }
            var adminTools = document.getElementById('admin-tools');
            if (isDev && adminTools) adminTools.classList.remove('hidden');
            var muteBtn = document.getElementById('mute-btn');
            var muteInput = document.getElementById('mute-input');
            if (isDev && muteBtn && muteInput) {
                muteBtn.addEventListener('click', function(){
                    var n = normalize(muteInput.value||'');
                    if (!n) return;
                    muteGlobalName(n);
                    muteInput.value = '';
                });
            }
            var isShutdown = false;
            
            function updateShutdownUI(){
                var input = document.getElementById('chat-input');
                var btn = document.getElementById('chat-send');
                var shutdownBtn = document.getElementById('shutdown-btn');
                var isDev = localStorage.getItem('dev_access') === 'true';
                
                if (isShutdown) {
                    if (shutdownBtn) shutdownBtn.textContent = "Open Chat";
                    if (!isDev) {
                        if (input) { input.disabled = true; input.placeholder = "Chat is currently disabled by admin."; }
                        if (btn) { btn.disabled = true; btn.classList.add('opacity-50'); }
                    } else {
                        // Admins can still type
                        if (input) { input.disabled = false; input.placeholder = "Chat disabled for others (You can type)"; }
                        if (btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }
                    }
                } else {
                    if (shutdownBtn) shutdownBtn.textContent = "Shutdown Chat";
                    if (input) { input.disabled = false; input.placeholder = "Type a message"; }
                    if (btn) { btn.disabled = false; btn.classList.remove('opacity-50'); }
                }
            }

            function send(){
                if (isShutdown && localStorage.getItem('dev_access') !== 'true') return;
                var input = document.getElementById('chat-input');
                var btn = document.getElementById('chat-send');
                if (!input || !btn) return;
                var s = sanitize(input.value||'');
                if (!s.ok){ setError(s.reason); return; }
                setError('');
                if (!rateOk()){ setError('Slow down'); return; }
                btn.disabled = true;
                
                var nameToUse = role || anon;
                
                // Attempt 1: Try to use the role as the name (for backward compatibility with old clients)
                // If the DB rules block this (e.g. name must be anonymousXXX), we fallback.
                var payload1 = { name: nameToUse, displayName: nameToUse, message: s.text, type: 'Global Chat' };
                
                function handleSuccess(){
                    input.value='';
                    btn.disabled = false;
                }
                
                function handleFail(err){
                    // Attempt 2: Fallback to anonymous name (satisfies strict DB rules)
                    // New clients will see displayName, old clients will see anonymousID
                    console.log("First attempt failed (likely DB name restriction), retrying with anonymous ID...", err);
                    
                    // IMPORTANT: We only send fields that are explicitly expected if the rules are strict.
                    // If the rules are: ".write": "newData.hasChildren(['name', 'message'])"
                    // Then sending extra fields like 'displayName' might be causing issues if .validate rules are strict.
                    // However, standard .write rules don't usually fail on extra children unless .validate forbids them.
                    
                    // Let's try sending just the standard payload but with the role in the message itself as a fallback
                    // OR, we assume the rules allow 'displayName'.
                    
                    var payload2 = { name: anon, displayName: nameToUse, message: s.text, type: 'Global Chat' };
                    
                    if (typeof submitGlobalChat === 'function') {
                        var p2 = submitGlobalChat(payload2);
                        if (p2 && typeof p2.then === 'function') {
                            p2.then(handleSuccess)
                              .catch(function(e){ 
                                  // Final Fallback: If even that failed, just send as pure anonymous
                                  console.log("Second attempt failed, sending as pure anonymous.");
                                  var payload3 = { name: anon, message: s.text, type: 'Global Chat' };
                                  submitGlobalChat(payload3).then(handleSuccess).catch(function(finalErr){
                                      setError('Error: ' + (finalErr.message||finalErr)); 
                                      btn.disabled = false;
                                  });
                              });
                        } else {
                            handleSuccess();
                        }
                    } else {
                        btn.disabled = false;
                        setError('Connection unavailable');
                    }
                }

                if (typeof submitGlobalChat === 'function') {
                    var p = submitGlobalChat(payload1);
                    if (p && typeof p.then === 'function') {
                        p.then(handleSuccess).catch(handleFail);
                    } else {
                        handleSuccess();
                    }
                } else {
                    btn.disabled = false;
                    setError('Connection unavailable');
                }
            }
            document.getElementById('chat-send').addEventListener('click', send);
            document.getElementById('chat-input').addEventListener('keypress', function(e){ if (e.key === 'Enter'){ e.preventDefault(); send(); } });
            
            var shutBtn = document.getElementById('shutdown-btn');
            if (shutBtn) {
                shutBtn.addEventListener('click', function(){
                    if (localStorage.getItem('dev_access') !== 'true') return;
                    firebase.database().ref('chat_shutdown').set(!isShutdown);
                });
            }

            function startListen(){
                if (typeof firebase === 'undefined') return;
                var db = firebase.database();
                
                db.ref('chat_shutdown').on('value', function(s){
                    isShutdown = s.val() === true;
                    updateShutdownUI();
                });

                var mutes = {};
                db.ref('global_chat_mutes').on('value', function(s){ mutes = (s.val()||{}); renderMutes(mutes); });
                db.ref('global_chat').limitToLast(100).on('value', function(snap){
                    var arr = [];
                    snap.forEach(function(child){
                        var v = child.val()||{};
                        var realName = String(v.displayName || v.name || '').toLowerCase();
                        var realSafe = realName.replace(/[^a-z0-9_-]/g,'');
                        
                        var nm = String(v.name||'').toLowerCase();
                        var nmSafe = nm.replace(/[^a-z0-9_-]/g,'');
                        
                        if (realSafe === 'chiefpenguin' || realSafe === 'leadpenguin') {
                            // Never hide admin role messages
                        } else if (nmSafe && mutes[nmSafe]) {
                            return;
                        }
                        arr.push({ key: child.key, name: v.name, displayName: v.displayName, message: v.message, timestamp: v.timestamp||0 });
                    });
                    arr.sort(function(a,b){ return (a.timestamp||0) - (b.timestamp||0); });
                    renderChat(arr);
                });
            }
            if (typeof firebase === 'undefined') {
                document.addEventListener('firebase-ready', startListen, { once: true });
            } else {
                startListen();
            }
        })();
    </script>
</body>
</html>
